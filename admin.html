<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>PrimeVest — Admin</title>
<style>
  body{font-family:Inter,system-ui,Arial;background:#f7faf9;margin:12px;color:#0b1720}
  h1{color:#064e3b}
  .card{background:#fff;padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:0 6px 18px rgba(12,20,24,0.04)}
  input{width:100%;padding:10px;border-radius:8px;border:1px solid #e6edf0;margin-top:8px}
  button.primary{background:#059669;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.reject{background:#ef4444;color:#fff;border:0;padding:8px 10px;border-radius:8px;cursor:pointer}
  .small{font-size:13px;color:#6b7280}
  .tx-row{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:8px;background:#fff;margin-bottom:8px;border:1px solid #eef2f5}
</style>
</head>
<body>
  <h1>PrimeVest — Admin</h1>

  <div id="loginCard" class="card">
    <h3>Admin Sign-in</h3>
    <p class="small">Username: <strong>Admin</strong> • Password: <strong>PrimeVest</strong></p>
    <input id="adUser" placeholder="Username"><br>
    <input id="adPass" type="password" placeholder="Password"><br><br>
    <button class="primary" onclick="adminLogin()">Sign in</button>
    <div id="adMsg" class="small" style="margin-top:8px"></div>
  </div>

  <div id="adminArea" class="hidden">
    <div class="card" style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>Pending Transactions</strong><div class="small">Only transactions created in this browser are shown</div></div>
      <div><button onclick="adminSignOut()">Sign out</button></div>
    </div>

    <div id="pendingList" class="card small">Loading pending transactions...</div>

    <div class="card">
      <h3>Confirm by Transaction ID</h3>
      <p class="small">If user sends tx id, paste here to confirm</p>
      <input id="txIdInput" placeholder="tx_..."><br><br>
      <button class="primary" onclick="confirmById()">Confirm tx by ID</button>
      <div id="manualMsg" class="small" style="margin-top:8px"></div>
    </div>
  </div>

<script>
const ADMIN_USER = 'Admin';
const ADMIN_PASS = 'PrimeVest';
const STORAGE_KEY = 'primevest_local_db';

function loadDB(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s?JSON.parse(s):{users:{},transactions:[]}; }catch(e){return {users:{},transactions:[]}; } }
function saveDB(db){ localStorage.setItem(STORAGE_KEY, JSON.stringify(db)); localStorage.setItem('pendingTransactions', JSON.stringify(db.transactions.filter(t=>t.status==='pending'))); localStorage.setItem('users', JSON.stringify(db.users)); }

function adminLogin(){
  const u = document.getElementById('adUser').value.trim();
  const p = document.getElementById('adPass').value;
  if(u === ADMIN_USER && p === ADMIN_PASS){
    document.getElementById('loginCard').classList.add('hidden');
    document.getElementById('adminArea').classList.remove('hidden');
    renderPending();
  } else {
    document.getElementById('adMsg').innerText = 'Invalid admin credentials';
  }
}

function adminSignOut(){ location.reload(); }

function renderPending(){
  const DB = loadDB();
  const pending = DB.transactions.filter(t=>t.status==='pending').sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  const container = document.getElementById('pendingList');
  if(!pending.length){ container.innerHTML = '<div class="small">No pending transactions in this browser.</div>'; return; }
  container.innerHTML = '';
  pending.forEach(tx=>{
    const div = document.createElement('div');
    div.className = 'tx-row';
    div.innerHTML = `
      <div>
        <div style="font-weight:800">₦${tx.amount.toLocaleString()}</div>
        <div class="small">User: ${tx.username}</div>
        <div class="small">Ref: ${tx.reference || '—'}</div>
        <div class="small">ID: ${tx.id}</div>
      </div>
      <div style="text-align:right">
        <button class="primary" onclick="confirmTx('${tx.id}')">Confirm</button>
        <button class="reject" onclick="rejectTx('${tx.id}')">Reject</button>
      </div>
    `;
    container.appendChild(div);
  });
}

function confirmTx(txId){
  const DB = loadDB();
  const idx = DB.transactions.findIndex(t=>t.id===txId);
  if(idx === -1){ alert('Transaction not found'); return; }
  const tx = DB.transactions[idx];
  if(tx.status !== 'pending'){ alert('Not pending'); renderPending(); return; }
  const user = DB.users[tx.username];
  if(!user){ alert('User not found locally'); return; }
  user.balance = (user.balance || 0) + tx.amount;
  user.totalFunded = (user.totalFunded || 0) + tx.amount;
  user.fundCount = (user.fundCount || 0) + 1;
  DB.users[tx.username] = user;
  DB.transactions[idx].status = 'confirmed';
  DB.transactions[idx].confirmedAt = new Date().toISOString();
  saveDB(DB);
  alert('Transaction confirmed and local balance updated.');
  renderPending();
}

function rejectTx(txId){
  const DB = loadDB();
  const idx = DB.transactions.findIndex(t=>t.id===txId);
  if(idx === -1){ alert('Not found'); return; }
  DB.transactions[idx].status = 'rejected';
  DB.transactions[idx].rejectedAt = new Date().toISOString();
  saveDB(DB);
  renderPending();
}

function confirmById(){
  const id = document.getElementById('txIdInput').value.trim();
  if(!id){ document.getElementById('manualMsg').innerText = 'Enter a tx id'; return; }
  const DB = loadDB();
  const idx = DB.transactions.findIndex(t=>t.id===id);
  if(idx === -1){ document.getElementById('manualMsg').innerText = 'Not found'; return; }
  if(DB.transactions[idx].status !== 'pending'){ document.getElementById('manualMsg').innerText = 'Not pending'; return; }
  const tx = DB.transactions[idx];
  if(!DB.users[tx.username]){ document.getElementById('manualMsg').innerText = 'User not found locally'; return; }
  DB.users[tx.username].balance = (DB.users[tx.username].balance||0) + tx.amount;
  DB.users[tx.username].totalFunded = (DB.users[tx.username].totalFunded||0) + tx.amount;
  DB.users[tx.username].fundCount = (DB.users[tx.username].fundCount||0) + 1;
  DB.transactions[idx].status = 'confirmed';
  DB.transactions[idx].confirmedAt = new Date().toISOString();
  saveDB(DB);
  document.getElementById('manualMsg').innerText = 'Confirmed.';
  renderPending();
}
</script>
</body>
</html>
